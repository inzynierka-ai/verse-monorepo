# Scene System Documentation

This document outlines the lifecycle of scenes within the game and provides a developer guide for the scene transition system.

## 1. Scene Lifecycle

This section describes the different statuses a scene can have and the transitions between them.

### Scene Statuses

*   **`generation_not_started`**: Initial status when a scene record is created but generation has not yet begun.
*   **`generating`**: Status when the scene's content, characters, and setting are actively being generated by the AI.
*   **`active`**: Status indicating the scene has been successfully generated and is currently playable by the user.
*   **`completed`**: Status when a player finishes a scene using the "Finish Scene" functionality.
*   **`failed`**: Status if an error occurs during the scene generation process, preventing it from becoming active.

### Status Transitions

*   A new scene is created with the **`generation_not_started`** status.
*   When generation begins, the status changes to **`generating`**.
*   Upon successful generation, the status becomes **`active`**.
*   If generation fails, the status changes to **`failed`**.
*   When a player completes an active scene, its status is updated to **`completed`**.

## 2. Scene Transition Developer Guide

This guide details the technical implementation of the scene transition system.

### A. Database Updates

*   The `Scene` model in the database has been updated to include a `status` field:
    ```python
    status = Column(String, default="generation_not_started", nullable=False)
    ```
*   A migration script was added to update existing scenes with this default status.
*   The Pydantic schema for `Scene` now also includes the `status` field.

### B. Scene Service Enhancements

The `SceneService` class has been enhanced with new methods and modifications to existing ones to manage scene statuses:

*   **`fetch_latest_active_scene(self, db: Session, story_id: int) -> Optional[Scene]`**: Retrieves the most recent scene for a given story that has an `active` status.
*   **`mark_scene_completed(self, db: Session, scene_uuid: uuid.UUID, story_id: int) -> Optional[Scene]`**: Updates the specified scene's status to `completed`.
*   **`process_completed_scene(self, db: Session, scene_id: int) -> None`**: Handles post-completion logic for a scene. It fetches messages, performs a basic summarization (calculating total messages and character participation), and stores this summary.
*   **`fetch_latest_scene`**: This method (or similar ones fetching scenes) has been updated to consider the `status` field, often filtering for `active` scenes depending on the use case.

### C. API Endpoint Changes

*   A new API endpoint has been added to mark a scene as completed:
    *   **`PATCH /{story_uuid}/scenes/{scene_uuid}/complete`**
    *   This endpoint changes the scene's status to `completed`.
    *   It expects `story_uuid` and `scene_uuid` as path parameters.
    *   It returns the updated scene object.
*   Existing endpoints that fetch the "latest" or "current" scene for a player (e.g., for loading into the game view) have been updated to primarily return `active` scenes.
*   If no `active` scene is found by these endpoints (often returning a 404 Not Found), this signals to the client (e.g., `GameView`) that a new scene generation process should be triggered.

### D. Scene Generator Integration

The `SceneGeneratorAgent` (or equivalent component responsible for generating scene content) has been updated to manage scene statuses throughout its process:

*   Sets status to **`generation_not_started`** when the scene entity is first created.
*   Updates status to **`generating`** while the AI is processing and creating the scene details.
*   Sets status to **`active`** once generation is successful and the scene is ready for the player.
*   In case of errors during generation, sets status to **`failed`**.

### E. Message Analysis Framework

*   The `process_completed_scene` method in the `SceneService` is responsible for analyzing messages from a completed scene.
*   This involves:
    1.  Fetching all messages associated with the `scene_id`.
    2.  Performing a basic summarization:
        *   Counting total messages.
        *   Calculating character participation (message counts per character).
        *   Placeholders exist for future, more advanced analysis like key event extraction and sentiment analysis.
    3.  Storing this summary data (e.g., in a `scene_summaries` table).

### F. Frontend Interaction

*   **`SceneView`**:
    *   The "Finish Scene" button, when clicked, calls the `PATCH /{story_uuid}/scenes/{scene_uuid}/complete` API endpoint.
    *   Upon successful completion, it navigates the player likely back to a `GameView` or a similar screen that would then trigger new scene generation or loading.
*   **`GameView`**:
    *   When loading, if the API endpoint for the latest scene returns a 404 (indicating no active scene), `GameView` initiates the scene generation process.
    *   It should display appropriate loading indicators to the player while a new scene is `generating`.

This covers the main components of the scene transition system.